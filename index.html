<style>
        body {
          color: white;
          font-family: arial;
          flex-direction: column;
          background-color: black;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        </style>
<body>
    <div>This is supposed to be zork.</div>
</body>

<script>
var width = 80;
var height = 25;
var charWidth = 10;
var charHeight = 20;

var c = document.createElement('canvas');
c.width = width * charWidth;
c.height = height * charHeight;
document.body.append(c);

var ctx = c.getContext('2d');
ctx.textAlign = "left";
ctx.font = '12px arial';

var machine_ptr;
var wasm_instance;

fetch('target/wasm32-unknown-unknown/release/rustzork.wasm')
.then(response => response.arrayBuffer())
.then(bytes => WebAssembly.instantiate(bytes, {
    env: {
        should_break: function() {
            console.log( "Should break" );
        },
        clear: function() {
            ctx.clearRect(0, 0, width*charWidth, height*charHeight);
        },
        put_line: function(x,y,ptr,len,r,g,b) {
            ctx.fillStyle = `rgb(${r},${g},${b})`;
            var text = "";
            var memory = new Uint8Array(wasm_instance.exports.memory.buffer, ptr, len);
            for( let n of memory.values() )
            {
                text += String.fromCharCode( n );
            }
            ctx.fillText(text, x*charWidth + charWidth / 2, y*charHeight + charHeight);
            //console.log(String.fromCharCode(char));
        }
    }
})
.then( results => {
    wasm_instance = results.instance;
    machine_ptr = results.instance.exports.initialize();
    function update() {
        window.requestAnimationFrame(update);
        results.instance.exports.update(machine_ptr);
    }
    update();
}));
</script>